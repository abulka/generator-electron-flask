<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Hello World!</title>
  <link rel="stylesheet" href="index.css">

  <% if (demoVueMain) { %>

    <!-- You MUST include jQuery before Fomantic -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

    <!-- Fomantic -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>

    <!-- Vue -->
    <script src="https://unpkg.com/vue@next"></script>

    <% } %>

</head <% if (demoVueMain) { %>background="cyan"<% } %> >

  <body>
    <p style="background-color: aquamarine;">This is the electron render process html - you can make this empty</p>
    <h1>ðŸ’– Hello World!</h1>
    <p>Welcome to your Electron application.</p>

    <% if (demoVueMain) { %>
      <div id="electron-index-vue" class="demo">
        Message is: {{ message }}

        <div class="inline field">
          <button class="ui button green" v-on:click="getInfo">
            getInfo
          </button>
          <button class="ui button yellow" v-on:click="sendEventToIframe">
            sendEventToIframe
          </button>
          <button class="ui button blue" v-on:click="doBootIframe">
            Re-initialise iframe html
          </button>
        </div>

        <!-- Links to flask rendered pages here is bad because whilst it works, you lose connection to the render process 
        html page and can never navigate back.  So load them into an iframe instead. -->
        <!-- <ul>
        <p>The following will take you to a flask rendered pages!</p>
        <li><a href="http://localhost:5000/hello">hello</a></li>
        <li><a href="http://localhost:5000/hello-vue">hello-vue</a></li>
      </ul> -->
      </div>

      <!-- iframe for flask pages-->
      <br>
      <p style="background-color: aquamarine;">This is the iframe where flask pages should be loaded</p>
      <iframe id="iframeout" class="runtime-output" style="height: 100%; width: 100%" srcdoc="">
        <p>Your browser does not support iframes.</p>
      </iframe>

      <script>
        const IndexVueApp = {
          data() {
            return {
              message: 'Hello Vue!!'
            }
          },
          methods: {
            getInfo() {
              $.ajax({
                method: "GET",
                url: `http://localhost:<%= portFlask %>`,
                data: {},
                // contentType: "application/json",
                success: response => {
                  this.message = response
                }
              });
            },
            sendEventToIframe() {
              let event = new CustomEvent('myCustomEventForIframe', { detail: { foo: 'bar2' } })
              document.querySelector('iframe.runtime-output').contentDocument.dispatchEvent(event)
            },
            doBootIframe() {
              bootIframe()
            }
          },
        }

        Vue.createApp(IndexVueApp).mount('#electron-index-vue')


        function bootIframe() {
          // Initialise iframe content. Presumably would could init with a flask page too?
          let output_html = `
            <ul>
              <p>The following will take you to flask rendered pages!</p>
              <li><a href="http://localhost:5000/hello">hello</a></li>
              <li><a href="http://localhost:5000/hello-vue">hello-vue</a></li>
            </ul>
            <ul>
              <p>Communication with iframe tests</p>
              <li><a href="javascript:window.parent.document.dispatchEvent(new CustomEvent('myCustomEvent', { detail: { foo: 'bar' } }));">Send myCustomEvent to parent of iframe (TO render process)</a></li>
              <li><a href="javascript:window.top.document.dispatchEvent(new CustomEvent('myCustomEvent', { detail: { foo: 'bar' } }));">Send myCustomEvent to window.top (TO render process)</a></li>
            </ul>
            `
          let iframe = document.querySelector('iframe.runtime-output')
          iframe.srcdoc = output_html

          // Initialise iframe, append some script
          iframe.onload = function () {
            const src = `
                window.document.addEventListener('myCustomEventForIframe', handleEvent, false)
                function handleEvent(e) {
                  console.log(e.detail)
                  alert('handleEvent() called - we are in the iframe page!')
                }

                console.log('iframe loaded ok')
            `
            const script = iframe.contentWindow.document.createElement("script");
            script.type = "text/javascript";
            script.innerHTML = src  // script.src = src; doesn't work
            iframe.contentWindow.document.body.appendChild(script);

          }
        }
        bootIframe()


        // Listen for custom events from iframe
        window.document.addEventListener('myCustomEvent', handleEvent, false)
        function handleEvent(e) {
          console.log(e.detail)
          alert('handleEvent() called - we are in renderer process!')
        }

      </script>
      <% } %>


  </body>

</html>