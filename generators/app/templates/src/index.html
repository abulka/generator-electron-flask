<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Hello World!</title>
  <link rel="stylesheet" href="index.css">

  <% if (demoVueMain) { %>

    <!-- You MUST include jQuery before Fomantic -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

    <!-- Fomantic -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>

    <!-- Vue -->
    <script src="https://unpkg.com/vue@next"></script>

    <% } %>

</head <% if (demoVueMain) { %>background="cyan"<% } %> >

  <body>
    <p style="background-color: aquamarine;">This is the electron render process html - you can make this empty</p>
    <h1>ðŸ’– Hello World!</h1>
    <p>Welcome to your Electron application.</p>

    <% if (demoVueMain) { %>
      <div id="electron-index-vue" class="demo">
        Message is: {{ message }}

        <div class="inline field">
          <button class="ui button green" v-on:click="getInfo">
            getInfo
          </button>
          <button class="ui button yellow" v-on:click="sendEventToIframe">
            sendEventToIframe
          </button>
          <button class="ui button blue" v-on:click="doBootIframe">
            Re-initialise iframe html with flask page
          </button>
          <button class="ui button cyan" v-on:click="doBootIframeDebug">
            Re-initialise iframe html debug
          </button>
        </div>

      </div>

      <!-- iframe for flask pages-->
      <br>
      <p style="background-color: aquamarine;">This is the iframe where flask pages should be loaded</p>
      <iframe id="iframeout" class="flask-pages" style="height: 100%; width: 100%" srcdoc="">
        <p>Your browser does not support iframes.</p>
      </iframe>

      <script>
        const IndexVueApp = {
          data() {
            return {
              message: 'Hello Vue!!'
            }
          },
          methods: {
            getInfo() {
              $.ajax({
                method: "GET",
                url: `http://localhost:<%= portFlask %>`,
                data: {},
                // contentType: "application/json",
                success: response => {
                  this.message = response
                }
              });
            },
            sendEventToIframe() {
              let event = new CustomEvent('eventFromRenderProcess', { detail: { foo: 'bar2' } })
              document.querySelector('iframe.flask-pages').contentDocument.dispatchEvent(event)
            },
            doBootIframe() {
                bootIframe('http://localhost:5000/hello')  // init with a flask page
            },
            doBootIframeDebug() {  // init iframe with hand crafted html - for debugging
                bootIframe()
            }
          },
        }

        Vue.createApp(IndexVueApp).mount('#electron-index-vue')


        function bootIframe(initialUrl=undefined) {
          // Initialise iframe content. Can also init with a flask page if supply a url.
          if (initialUrl) {
              let iframe = document.querySelector('iframe.flask-pages')
              iframe.contentWindow.location.assign(initialUrl)
              return
          }

          let output_html = `
            <ul>
              <p>The following will take you to flask rendered pages!</p>
              <li><a href="http://localhost:5000/hello">hello</a></li>
              <li><a href="http://localhost:5000/hello-vue">hello-vue</a></li>
            </ul>
            <ul>
              <p>Communication from iframe pages to electron render process html</p>
              <li><a href="javascript:window.parent.document.dispatchEvent(new CustomEvent('eventFromIframePage', { detail: { foo: 'bar' } }));">Send event to window.parent</a></li>
              <li><a href="javascript:window.top.document.dispatchEvent(new CustomEvent('eventFromIframePage', { detail: { foo: 'bar' } }));">Send event to window.top</a></li>
            </ul>
            `
          let iframe = document.querySelector('iframe.flask-pages')
          iframe.srcdoc = output_html

          // Initialise iframe, append some script - but interesting, this stays around even when navigate away!
          iframe.onload = function () {
            const src = `
                // Example of listening for events from render process html - any flask page should also add this kind of code
                window.document.addEventListener('eventFromRenderProcess', handleEvent, false)
                function handleEvent(e) {
                  console.log(e.detail)
                  alert('iframe BOOT page received event from electron render process.')
                }

                console.log('iframe BOOT page loaded ok')
            `
            const script = iframe.contentWindow.document.createElement("script");
            script.type = "text/javascript";
            script.innerHTML = src  // script.src = src; doesn't work
            iframe.contentWindow.document.body.appendChild(script);

          }
        }
        // bootIframe()  // init with a custom hand coded page
        bootIframe('http://localhost:5000/hello')  // init with a flask page


        // In electron render process html, listen for possible custom events from iframe pages
        // You could in turn talk to the electron main process from here, thus offering a way for
        // flask pages to talk to both the render process and the main process.
        window.document.addEventListener('eventFromIframePage', handleEvent, false)
        function handleEvent(e) {
          console.log(e.detail)
          alert('electron render process html received event from iframe page.')
        }

      </script>
      <% } %>


  </body>

</html>